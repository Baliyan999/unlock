#!/bin/bash

# ะะตะทะพะฟะฐัะฝะพะต ัะฐะทะฒะตัััะฒะฐะฝะธะต ั ะฐะฒัะพะผะฐัะธัะตัะบะธะผ ะฑัะบะฐะฟะพะผ
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./safe_deploy.sh

set -e

echo "๐ ะะตะทะพะฟะฐัะฝะพะต ัะฐะทะฒะตัััะฒะฐะฝะธะต UnlockLingua..."

# 1. ะกะพะทะดะฐะตะผ ะฑัะบะฐะฟ ะฑะฐะทั ะดะฐะฝะฝัั
echo "๐ฆ ะกะพะทะดะฐะตะผ ะฑัะบะฐะฟ ะฑะฐะทั ะดะฐะฝะฝัั..."
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="./backend/data/unlocklingua_backup_${TIMESTAMP}.db"

if [ -f "./backend/data/unlocklingua.db" ]; then
    cp "./backend/data/unlocklingua.db" "$BACKUP_FILE"
    echo "โ ะัะบะฐะฟ ัะพะทะดะฐะฝ: $BACKUP_FILE"
else
    echo "โ๏ธ ะะฐะทะฐ ะดะฐะฝะฝัั ะฝะต ะฝะฐะนะดะตะฝะฐ ะฒ ./backend/data/"
fi

# 2. ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะบะพะฝัะตะนะฝะตัั
echo "โน๏ธ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะบะพะฝัะตะนะฝะตัั..."
docker-compose down

# 3. ะะฑะฝะพะฒะปัะตะผ ะบะพะด (ะตัะปะธ ะฝัะถะฝะพ)
echo "๐ฅ ะะฑะฝะพะฒะปัะตะผ ะบะพะด..."
# git pull  # ะะฐัะบะพะผะผะตะฝัะธััะนัะต, ะตัะปะธ ะธัะฟะพะปัะทัะตัะต git

# 4. ะะตัะตัะพะฑะธัะฐะตะผ ะธ ะทะฐะฟััะบะฐะตะผ
echo "๐จ ะะตัะตัะพะฑะธัะฐะตะผ ะธ ะทะฐะฟััะบะฐะตะผ..."
docker-compose up --build -d

# 5. ะัะพะฒะตััะตะผ, ััะพ ะฒัะต ัะฐะฑะพัะฐะตั
echo "๐ ะัะพะฒะตััะตะผ ัะตัะฒะธัั..."
sleep 10

# ะัะพะฒะตััะตะผ API
if curl -f http://localhost:8000/health > /dev/null 2>&1; then
    echo "โ API ัะฐะฑะพัะฐะตั"
else
    echo "โ API ะฝะต ะพัะฒะตัะฐะตั"
fi

# ะัะพะฒะตััะตะผ ััะพะฝัะตะฝะด
if curl -f http://localhost:3000 > /dev/null 2>&1; then
    echo "โ ะคัะพะฝัะตะฝะด ัะฐะฑะพัะฐะตั"
else
    echo "โ ะคัะพะฝัะตะฝะด ะฝะต ะพัะฒะตัะฐะตั"
fi

echo "๐ ะะฐะทะฒะตัััะฒะฐะฝะธะต ะทะฐะฒะตััะตะฝะพ!"
echo "๐ ะัะบะฐะฟ ะฑะฐะทั: $BACKUP_FILE"
echo "๐ ะกะฐะนั: http://localhost:3000"
echo "๐ง API: http://localhost:8000"
