# Система отзывов через Telegram-бота

## Описание

Система позволяет пользователям оставлять отзывы через Telegram-бота, которые проходят модерацию администрации и публикуются на сайте.

## Архитектура

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Пользователь  │───▶│  Telegram Bot   │───▶│   База данных   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │   Администратор │    │   Веб-сайт      │
                       └─────────────────┘    └─────────────────┘
```

## Установка и настройка

### 1. Создание Telegram-бота

1. Напишите [@BotFather](https://t.me/BotFather) в Telegram
2. Создайте нового бота командой `/newbot`
3. Следуйте инструкциям и получите токен бота
4. Установите команды бота:
   ```
   start - Начать работу с ботом
   help - Получить помощь
   ```

### 2. Настройка переменных окружения

Создайте файл `.env` в корне проекта:

```env
# Telegram Bot
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_CHAT_ID=your_admin_chat_id_here

# Database
DATABASE_URL=./api/db/reviews.db

# API
API_PORT=3001
```

### 3. Установка зависимостей

```bash
# Установка зависимостей для API
cd api
npm install

# Установка зависимостей для фронтенда (если нужно)
cd ..
npm install
```

### 4. Запуск системы

```bash
# Запуск API сервера
cd api
npm start

# В другом терминале - запуск фронтенда
npm run dev
```

## Функционал

### Для пользователей

1. **Оставить отзыв**:
   - Нажимают кнопку "Оставить отзыв" на сайте
   - Переходят в Telegram-бота
   - Выбирают "📝 Оставить отзыв"
   - Вводят текст отзыва (минимум 10 символов)
   - Выбирают оценку от 0 до 5 с шагом 0.5
   - Отзыв отправляется на модерацию

2. **Другие функции**:
   - "ℹ️ О курсах" - информация о курсах
   - "📞 Связаться с нами" - контакты

### Для администрации

1. **Модерация отзывов**:
   - Получают уведомления о новых отзывах
   - Видят полную информацию о пользователе
   - Могут одобрить или отклонить отзыв
   - Одобренные отзывы автоматически публикуются на сайте

2. **Статистика**:
   - Общее количество отзывов
   - Количество одобренных/отклоненных
   - Средний рейтинг

## API Endpoints

### Получение опубликованных отзывов
```
GET /api/reviews
```

### Создание нового отзыва
```
POST /api/reviews?action=create
Content-Type: application/json

{
  "user_id": 123456789,
  "username": "username",
  "first_name": "Имя",
  "last_name": "Фамилия",
  "text": "Текст отзыва",
  "rating": 4.5
}
```

### Получение всех отзывов для админа
```
GET /api/reviews/admin
```

### Обновление статуса отзыва
```
PUT /api/reviews/:id?action=update
Content-Type: application/json

{
  "status": "approved", // или "rejected"
  "adminId": 123456789,
  "adminUsername": "admin_username"
}
```

### Статистика отзывов
```
GET /api/reviews/stats
```

## Структура базы данных

### Таблица `reviews`
```sql
CREATE TABLE reviews (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id BIGINT NOT NULL,
    username VARCHAR(255),
    first_name VARCHAR(255),
    last_name VARCHAR(255),
    text TEXT NOT NULL,
    rating DECIMAL(2,1) NOT NULL CHECK (rating >= 0 AND rating <= 5),
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    approved_at DATETIME,
    admin_id BIGINT,
    admin_username VARCHAR(255)
);
```

## Безопасность

1. **Валидация данных**:
   - Проверка длины текста отзыва
   - Проверка диапазона рейтинга
   - Санитизация пользовательского ввода

2. **Ограничения**:
   - Минимум 10 символов в отзыве
   - Рейтинг от 0 до 5 с шагом 0.5
   - Только админы могут изменять статус

3. **CORS**:
   - Настроен для работы с фронтендом
   - Ограниченные методы и заголовки

## Мониторинг

### Health Check
```
GET /health
```

Возвращает статус API и бота.

### Логирование

Все действия логируются в консоль:
- Создание отзывов
- Изменение статусов
- Ошибки API
- Ошибки бота

## Развертывание

### Vercel (рекомендуется)

1. Подключите репозиторий к Vercel
2. Установите переменные окружения в настройках проекта
3. Настройте отдельный сервер для API (например, Railway, Heroku)

### Docker

```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY api/package*.json ./
RUN npm install

COPY api/ ./

EXPOSE 3001

CMD ["npm", "start"]
```

## Troubleshooting

### Частые проблемы

1. **Бот не отвечает**:
   - Проверьте токен бота
   - Убедитесь, что бот запущен
   - Проверьте логи API

2. **Отзывы не сохраняются**:
   - Проверьте подключение к БД
   - Убедитесь в правах доступа к файлу БД

3. **Отзывы не отображаются на сайте**:
   - Проверьте API endpoint
   - Убедитесь, что отзывы имеют статус "approved"

### Логи

```bash
# Просмотр логов API
cd api
npm run dev

# Проверка статуса
curl http://localhost:3001/health
```

## Дальнейшее развитие

1. **Уведомления**:
   - Email уведомления для админов
   - Push уведомления в Telegram

2. **Аналитика**:
   - Детальная статистика отзывов
   - Графики и диаграммы

3. **Модерация**:
   - Автоматическая модерация по ключевым словам
   - Система репутации пользователей

4. **Интеграции**:
   - Интеграция с CRM
   - Экспорт отзывов
   - API для мобильного приложения
